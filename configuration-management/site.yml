---
- name: Configure Azure VM for Production Deployment
  hosts: azure_vms
  become: true
  gather_facts: true

  pre_tasks:
    - name: Update package cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      tags: [system, updates]

  roles:
    - role: system-hardening
      tags: [system, security, hardening]

    - role: firewall
      tags: [security, firewall]

    - role: ssh-hardening
      tags: [security, ssh]

    - role: fail2ban
      tags: [security, fail2ban]

    - role: time-sync
      tags: [system, time]

    - role: azure-monitor
      tags: [monitoring, azure]

    - role: cron-jobs
      tags: [system, cron, backup]

  post_tasks:
    - name: Verify all services are running
      ansible.builtin.service:
        name: "{{ item }}"
        state: started
        enabled: true
      loop:
        - fail2ban
        - chrony
      tags: [verification]

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "Deployment completed successfully!"
          - "SSH Port: {{ ssh_port | default('22') }}"
      tags: [summary]
